<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

var express = require('express'),
	APIError = require('./lib/APIError'),
	lift = require('./lib/lift'),
	versions = require('./lib/versions'),
	bodyParser = require('body-parser'),
	genId = require('./lib/genId'),
	API = require('./lib/API')

/**
 * @module api-lift
 */

/**
 * The module responsible for reading the files in the target folder
 * @external lift-it
 * @see https://www.npmjs.com/package/lift-it
 */

/**
 * Express module
 * @external express
 * @see https://www.npmjs.com/package/express
 */

/**
 * Lift the API
 * @param {Object} [options] - see defaults in README
 * @returns {API}
 */
module.exports = function (options) {
	options = prepareOptions(options)

	// Lift and call error callbacks
	var lifted = lift(options)

	var api = new API(lifted, options.dataScrub, options.onsuccess, options.onfailure)

	// Prepare express middlewares
	api.router.use(function (req, res, next) {
		// Save the time at the beggining
		req.runInfo = {
			beginTime: Date.now(),
			requestId: genId(),
			req: req
		}

		if (req.method === 'POST' &amp;&amp; !req.is('json')) {
			return next(APIError.create(101,
				'Invalid Content-Type header, application/json was expected'))
		}

		next()
	})
	api.router.use(bodyParser.json())

	// Create the endpoints using versioning
	api._prepareEndpoints(options.minVersion)

	// Prepare express endpoint handler
	api.router.use(function (req, res, next) {
		if (req.method !== 'POST' || !req.body) {
			// We're only looking into POST requests
			return next()
		}

		api.run(req.url, req.body, req.runInfo, function (out) {
			res.json(out)
		})
	})

	// Error handler
	api.router.use(function (err, req, res, next) {
		next // next isn't used on purpose, because express demands a 4-arity function
		if (err instanceof Error &amp;&amp; err.status === 400 &amp;&amp; typeof err.body === 'string') {
			// JSON parsing error
			err = APIError.create(101, 'Invalid JSON: ' + err)
		}
		api._handleError(err, req.body, req.runInfo, null, function (out) {
			res.json(out)
		})
	})

	return api
}

/**
 * @param {Object} [options]
 * @returns {Versions}
 */
module.exports.info = function (options) {
	options = prepareOptions(options)
	return versions(options.minVersion, lift.lean(options).actions)
}

/** Exposes used version of {@link external:express} */
module.exports.express = express

/** Exposes {@link APIError} class */
module.exports.APIError = APIError

/**
 * @param {?Object} options
 * @returns {Object}
 * @private
 */
function prepareOptions(options) {
	var vO

	// Set defaults
	options = options || {}
	options.folder = options.folder || './api'
	options.profile = Boolean(options.profile)
	options.dataScrub = options.dataScrub || [/session|password|serial|token/i]
	options.validate = options.validate || {}

	// Set validateOutput defaults
	vO = options.validateOutput = options.validateOutput || {}
	vO.direction = 'output'
	vO.exportName = vO.exportName || 'outFields'
	vO.optional = vO.optional === undefined ? true : vO.optional
	vO.getDefaultValue = vO.getDefaultValue || function () {
		return {}
	}
	vO.code = vO.code || 100
	vO.errorHandler = vO.errorHandler || function (action, value, err) {
		throw err
	}
	vO.options = vO.options || {}
	vO.options.strict = vO.options.strict === undefined ? true : vO.options.strict

	options.filters = options.filters || './filters'
	options.minVersion = options.minVersion === undefined ? 1 : options.minVersion
	options.onerror = options.onerror || function (action) {
		throw action.error
	}

	return options
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api-lift.html">api-lift</a></li></ul><h3>Externals</h3><ul><li><a href="external-express.html">express</a></li><li><a href="external-lift-it.html">lift-it</a></li></ul><h3>Classes</h3><ul><li><a href="API.html">API</a></li><li><a href="APIError.html">APIError</a></li><li><a href="Endpoint.html">Endpoint</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Sun Jun 07 2015 14:54:34 GMT-0300 (Hora oficial do Brasil)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
